openapi: 3.1.0
info:
  title: Service Configuration Service API
  description: ServiceService for provider, service, and webhook configuration in the AREA project
  version: 1.0.0
  contact:
    name: AREA Team
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:8084
    description: Local development server
  - url: http://api:8084
    description: Docker internal network

paths:
  /health:
    get:
      summary: Health check endpoint
      description: Returns the health status of the microservice
      operationId: healthCheck
      tags:
        - Health
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      status:
                        type: string
                        example: healthy

  /providers/services:
    get:
      summary: Get all available OAuth2 providers
      description: Returns a list of all configured OAuth2 provider names
      operationId: getServices
      tags:
        - Providers
      responses:
        '200':
          description: Successfully retrieved service list
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      services:
                        type: array
                        items:
                          type: string
                        example: ["google", "discord", "github"]
        '405':
          description: Method not allowed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /providers/oauth2-config:
    get:
      summary: Get OAuth2 configuration for a service
      description: Returns the OAuth2 configuration (client ID, auth URL, scopes, etc.) for a specific provider
      operationId: getOAuth2Config
      tags:
        - Providers
      parameters:
        - name: service
          in: query
          required: true
          description: The name of the OAuth2 service
          schema:
            type: string
            example: google
      responses:
        '200':
          description: Successfully retrieved OAuth2 configuration
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/OAuth2Config'
        '400':
          description: Bad request - Missing service parameter
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Service not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '405':
          description: Method not allowed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /providers/config:
    get:
      summary: Get full provider configuration
      description: Returns the complete provider configuration including OAuth2 settings and field mappings
      operationId: getProviderConfig
      tags:
        - Providers
      parameters:
        - name: service
          in: query
          required: true
          description: The name of the OAuth2 service
          schema:
            type: string
            example: google
      responses:
        '200':
          description: Successfully retrieved provider configuration
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/ProviderConfig'
        '400':
          description: Bad request - Missing service parameter
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Service not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '405':
          description: Method not allowed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /webhooks/providers:
    get:
      summary: Get all available webhook providers
      description: Returns a list of all configured webhook providers
      operationId: getWebhookProviders
      tags:
        - Webhooks
      responses:
        '200':
          description: Successfully retrieved provider list
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      providers:
                        type: array
                        items:
                          type: string
                        example: ["github", "generic"]
        '405':
          description: Method not allowed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /webhooks/providers/config:
    get:
      summary: Get webhook provider configuration
      description: Returns the webhook validation and mapping configuration for a provider
      operationId: getWebhookProviderConfig
      tags:
        - Webhooks
      parameters:
        - name: provider
          in: query
          required: true
          description: The name of the webhook provider
          schema:
            type: string
            example: github
      responses:
        '200':
          description: Successfully retrieved webhook provider configuration
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/WebhookProviderConfig'
        '400':
          description: Bad request - Missing provider parameter
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Provider not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '405':
          description: Method not allowed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /services/services:
    get:
      summary: Get all available services
      description: Returns a list of all configured service names
      operationId: getServiceNames
      tags:
        - Services
      responses:
        '200':
          description: Successfully retrieved service list
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      services:
                        type: array
                        items:
                          type: string
                        example: ["timer", "google_calendar", "github"]
        '405':
          description: Method not allowed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /services/service-config:
    get:
      summary: Get service configuration
      description: Returns the action/reaction configuration for a specific service
      operationId: getServiceConfig
      tags:
        - Services
      parameters:
        - name: service
          in: query
          required: true
          description: The name of the service
          schema:
            type: string
            example: google_calendar
      responses:
        '200':
          description: Successfully retrieved service configuration
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/ServiceConfig'
        '400':
          description: Bad request - Missing service parameter
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Service not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '405':
          description: Method not allowed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: string
          example: An error occurred
      required:
        - success
        - error

    OAuth2Config:
      type: object
      properties:
        client_id:
          type: string
          example: GOOGLE_CLIENT_ID
        client_secret:
          type: string
          example: GOOGLE_CLIENT_SECRET
        auth_url:
          type: string
          example: https://accounts.google.com/o/oauth2/v2/auth
        token_url:
          type: string
          example: https://oauth2.googleapis.com/token
        redirect_uri:
          type: string
          example: http://localhost:8083/oauth2/callback
        scopes:
          type: array
          items:
            type: string
          example: ["openid", "email", "profile"]
        user_info_url:
          type: string
          example: https://www.googleapis.com/oauth2/v2/userinfo

    FieldMapping:
      type: object
      properties:
        field_key:
          type: string
          example: email
        json_path:
          type: string
          example: email
        type:
          type: string
          enum: [string, number, boolean, json]
          example: string
        optional:
          type: boolean
          example: true

    ProviderConfig:
      type: object
      properties:
        name:
          type: string
          example: google
        oauth2:
          $ref: '#/components/schemas/OAuth2Config'
        mappings:
          type: array
          items:
            $ref: '#/components/schemas/FieldMapping'

    ServiceFieldConfig:
      type: object
      properties:
        name:
          type: string
          example: summary
        type:
          type: string
          example: text
        label:
          type: string
          example: Event title
        required:
          type: boolean
          example: true
        default:
          type: string
          example: ""
        selection:
          type: array
          items:
            $ref: '#/components/schemas/FieldSelectionOption'
        multiple:
          type: boolean
          example: false

    FieldSelectionOption:
      type: object
      properties:
        value:
          type: string
          example: push
        label:
          type: string
          example: Push

    OutputField:
      type: object
      properties:
        name:
          type: string
          example: delay
        type:
          type: string
          example: number
        label:
          type: string
          example: Delay (seconds)

    BodyField:
      type: object
      properties:
        path:
          type: string
          example: summary
        type:
          type: string
          example: text
        value:
          description: Raw value or nested body fields
          oneOf:
            - type: string
              example: "{{summary}}"
            - type: number
              example: 42
            - type: boolean
              example: true
            - type: array
              items:
                $ref: '#/components/schemas/BodyField'

    ActionConfig:
      type: object
      properties:
        title:
          type: string
          example: delay_action
        label:
          type: string
          example: Delay Action
        type:
          type: string
          example: cron
        fields:
          type: array
          items:
            $ref: '#/components/schemas/ServiceFieldConfig'
        output_fields:
          type: array
          items:
            $ref: '#/components/schemas/OutputField'

    ReactionConfig:
      type: object
      properties:
        title:
          type: string
          example: create_event
        label:
          type: string
          example: Create Event
        url:
          type: string
          example: https://www.googleapis.com/calendar/v3/calendars/{{calendar}}/events
        fields:
          type: array
          items:
            $ref: '#/components/schemas/ServiceFieldConfig'
        method:
          type: string
          example: POST
        bodyType:
          type: string
          example: json
        body_struct:
          type: array
          items:
            $ref: '#/components/schemas/BodyField'

    ServiceConfig:
      type: object
      properties:
        provider:
          type: string
          example: google
        name:
          type: string
          example: google_calendar
        icon_url:
          type: string
          example: ""
        label:
          type: string
          example: Google Calendar
        actions:
          type: array
          items:
            $ref: '#/components/schemas/ActionConfig'
        reactions:
          type: array
          items:
            $ref: '#/components/schemas/ReactionConfig'

    WebhookSignatureConfig:
      type: object
      properties:
        type:
          type: string
          example: hmac
        header:
          type: string
          example: X-Hub-Signature-256
        prefix:
          type: string
          example: sha256=
        secret_json_path:
          type: string
          example: secret
        algorithm:
          type: string
          example: sha256
        encoding:
          type: string
          example: hex
        signing_string_template:
          type: string
          example: "v0:{{headers.X-Slack-Request-Timestamp}}:{{body}}"
        timestamp_header:
          type: string
          example: X-Slack-Request-Timestamp
        timestamp_tolerance_seconds:
          type: integer
          example: 300

    WebhookProviderConfig:
      type: object
      properties:
        name:
          type: string
          example: github
        payload_format:
          type: string
          enum: [json, xml]
          example: json
        oauth_provider:
          type: string
          example: google
        topic_template:
          type: string
          example: https://www.youtube.com/xml/feeds/videos.xml?channel_id={{config.channel_id}}
        signature:
          $ref: '#/components/schemas/WebhookSignatureConfig'
        event_header:
          type: string
          example: X-GitHub-Event
        event_json_path:
          type: string
          example: type
        event_allow_serviceConfigFile_path:
          type: string
          example: events
        event_ignore:
          type: array
          items:
            type: string
          example: ["ping"]
        mappings:
          type: array
          items:
            $ref: '#/components/schemas/FieldMapping'
        prepare:
          type: array
          items:
            $ref: '#/components/schemas/WebhookProviderPrepareStep'
        renewal:
          $ref: '#/components/schemas/WebhookProviderRenewalConfig'
        setup:
          $ref: '#/components/schemas/WebhookProviderSetupConfig'
        teardown:
          $ref: '#/components/schemas/WebhookProviderSetupConfig'

    WebhookProviderAuthConfig:
      type: object
      properties:
        type:
          type: string
          example: oauth2
        header:
          type: string
          example: Authorization
        prefix:
          type: string
          example: Bearer 
        provider:
          type: string
          example: google

    WebhookProviderSetupConfig:
      type: object
      properties:
        method:
          type: string
          example: POST
        url_template:
          type: string
          example: https://api.github.com/repos/{{config.repository}}/hooks
        headers:
          type: object
          additionalProperties:
            type: string
        auth:
          $ref: '#/components/schemas/WebhookProviderAuthConfig'
        body_encoding:
          type: string
          enum: [json, form, x-www-form-urlencoded]
          example: json
        body_template:
          type: object
        repeat_for:
          type: string
          example: config.topics
        response_id_json_path:
          type: string
          example: id

    WebhookPrepareCondition:
      type: object
      properties:
        json_path:
          type: string
          example: mode
        equals:
          type: string
          example: subscriptions
        in:
          type: array
          items:
            type: string
          example: ["subscriptions", "all"]
        exists:
          type: boolean
          example: true

    WebhookProviderPaginationConfig:
      type: object
      properties:
        request_param:
          type: string
          example: pageToken
        response_json_path:
          type: string
          example: nextPageToken

    WebhookProviderFetchConfig:
      type: object
      properties:
        method:
          type: string
          example: GET
        url_template:
          type: string
          example: https://www.googleapis.com/youtube/v3/subscriptions?part=snippet&mine=true&maxResults=50
        headers:
          type: object
          additionalProperties:
            type: string
        auth:
          $ref: '#/components/schemas/WebhookProviderAuthConfig'
        body_encoding:
          type: string
          enum: [json, form, x-www-form-urlencoded]
        body_template:
          type: object
        response_json_path:
          type: string
          example: items
        item_json_path:
          type: string
          example: snippet.resourceId.channelId
        store_path:
          type: string
          example: channel_ids
        pagination:
          $ref: '#/components/schemas/WebhookProviderPaginationConfig'

    WebhookProviderTemplateListConfig:
      type: object
      properties:
        repeat_for:
          type: string
          example: config.channel_ids
        template:
          type: string
          example: https://www.youtube.com/xml/feeds/videos.xml?channel_id={{item}}
        store_path:
          type: string
          example: topics
        unique:
          type: boolean
          example: true

    WebhookProviderExtractConfig:
      type: object
      properties:
        source_json_path:
          type: string
          example: channel_url
        regex:
          type: string
          example: "^https?://(www\\.)?youtube\\.com/@([^/?#]+)"
        group:
          type: integer
          example: 2
        store_path:
          type: string
          example: handle
        optional:
          type: boolean
          example: true

    WebhookProviderGenerateConfig:
      type: object
      properties:
        store_path:
          type: string
          example: secret
        length:
          type: integer
          example: 32
        encoding:
          type: string
          enum: [hex, base64]
          example: hex
        only_if_missing:
          type: boolean
          example: true

    WebhookProviderRenewalConfig:
      type: object
      properties:
        after_seconds:
          type: integer
          example: 800000

    WebhookProviderPrepareStep:
      type: object
      properties:
        when:
          $ref: '#/components/schemas/WebhookPrepareCondition'
        fetch:
          $ref: '#/components/schemas/WebhookProviderFetchConfig'
        template_list:
          $ref: '#/components/schemas/WebhookProviderTemplateListConfig'
        extract:
          $ref: '#/components/schemas/WebhookProviderExtractConfig'
        generate:
          $ref: '#/components/schemas/WebhookProviderGenerateConfig'

tags:
  - name: Health
    description: Health check endpoints
  - name: Providers
    description: OAuth2 provider configuration endpoints
  - name: Services
    description: Service configuration endpoints
  - name: Webhooks
    description: Webhook provider configuration endpoints
