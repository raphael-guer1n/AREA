name: CI - Mirror to Official Epitech Repo

on:
  push:
    branches: [main, dev]

jobs:
  mirror:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}

      - name: Start SSH agent
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Push to Epitech mirror
        run: |
          git remote remove mirror 2>/dev/null || true
          git remote add mirror "${{ secrets.MIRROR_URL }}"
          
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          git push mirror "$BRANCH_NAME:$BRANCH_NAME" --force

      - name: Push all branches (optional)
        if: github.ref == 'refs/heads/main'
        run: |
          # Only push both branches when main is updated
          git push mirror main:main dev:dev --force
